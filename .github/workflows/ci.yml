name: CI

on:
  push:
    branches: [ "*" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [24.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v6
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Run linter
      run: npm run lint

    - name: Compile TypeScript
      run: npm run compile

    - name: Setup virtual display
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb

    - name: Run full test suite
      run: xvfb-run -a npm test
      continue-on-error: false

  build:
    needs: test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '24.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Install vsce (VS Code Extension Manager)
      run: npm install -g @vscode/vsce

    - name: Compile extension
      run: npm run vscode:prepublish

    - name: Determine version suffix
      id: version
      run: |
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "suffix=" >> $GITHUB_OUTPUT
          echo "release_type=release" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" = "refs/heads/debug" ]; then
          echo "suffix=-debug" >> $GITHUB_OUTPUT
          echo "release_type=debug" >> $GITHUB_OUTPUT
        fi
        echo "sha_short=$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_OUTPUT

    - name: Update package.json version for non-main builds
      if: github.ref != 'refs/heads/main'
      run: |
        # Get current version and append build info
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        NEW_VERSION="${CURRENT_VERSION}${{ steps.version.outputs.suffix }}-${GITHUB_RUN_NUMBER}+${{ steps.version.outputs.sha_short }}"
        npm version "$NEW_VERSION" --no-git-tag-version
        echo "Updated version to: $NEW_VERSION"

    - name: Package extension
      run: vsce package

    - name: Get package filename
      id: package
      run: |
        PACKAGE_FILE=$(ls *.vsix | head -1)
        echo "filename=$PACKAGE_FILE" >> $GITHUB_OUTPUT
        echo "name=$(basename "$PACKAGE_FILE" .vsix)" >> $GITHUB_OUTPUT

    - name: Upload VSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: vscode-extension-${{ steps.version.outputs.release_type }}-${{ steps.version.outputs.sha_short }}
        path: ${{ steps.package.outputs.filename }}
        retention-days: 30
